package org.taxireferral.sds.DAOs;

import com.zaxxer.hikari.HikariDataSource;
import org.taxireferral.sds.Globals.Globals;
import org.taxireferral.sds.ModelEndpoints.ServiceConfigEndpoint;
import org.taxireferral.sds.ModelSettings.ServiceConfiguration;

import java.sql.*;
import java.util.ArrayList;

/**
 * Created by sumeet on 28/12/16.
 */
public class ServiceConfigurationDAO {

    private HikariDataSource dataSource = Globals.getDataSource();


    public int insertServiceConfig(ServiceConfiguration serviceConfiguration)
    {

        Connection connection = null;
        PreparedStatement statement = null;
        int rowIdOfInsertedRow = -1;

        String insertShop = "INSERT INTO "
                + ServiceConfiguration.TABLE_NAME
                + "("

                + ServiceConfiguration.LOGO_IMAGE_PATH + ","
                + ServiceConfiguration.BACKDROP_IMAGE_PATH + ","

                + ServiceConfiguration.SERVICE_NAME + ","
                + ServiceConfiguration.HELPLINE_NUMBER + ","

                + ServiceConfiguration.DESCRIPTION_SHORT + ","
                + ServiceConfiguration.DESCRIPTION_LONG + ","

                + ServiceConfiguration.ADDRESS + ","
                + ServiceConfiguration.CITY + ","
                + ServiceConfiguration.PINCODE + ","
                + ServiceConfiguration.LANDMARK + ","
                + ServiceConfiguration.STATE + ","
                + ServiceConfiguration.COUNTRY + ","

                + ServiceConfiguration.ISO_COUNTRY_CODE + ","
                + ServiceConfiguration.ISO_LANGUAGE_CODE + ","
                + ServiceConfiguration.ISO_CURRENCY_CODE + ","

                + ServiceConfiguration.SERVICE_TYPE + ","

                + ServiceConfiguration.LAT_CENTER + ","
                + ServiceConfiguration.LON_CENTER + ","

                + ServiceConfiguration.SERVICE_RANGE + ","

                + ServiceConfiguration.IS_OFFICIAL_SERVICE_PROVIDER + ","
                + ServiceConfiguration.IS_VERIFIED + ","
                + ServiceConfiguration.SERVICE_URL + ","

                + ServiceConfiguration.CREATED + ","
                + ServiceConfiguration.UPDATED + ""
                + " ) VALUES (?,? ,?,? ,?,? ,?,?,?,?,?,? ,?,?,?, ?, ?,?, ?, ?,?,? ,?,?)";

        try {

            connection = dataSource.getConnection();

            statement = connection.prepareStatement(insertShop,PreparedStatement.RETURN_GENERATED_KEYS);

            int i = 0;
            statement.setString(++i, serviceConfiguration.getLogoImagePath());
            statement.setString(++i, serviceConfiguration.getBackdropImagePath());
            statement.setString(++i, serviceConfiguration.getServiceName());
            statement.setString(++i, serviceConfiguration.getHelplineNumber());

            statement.setString(++i, serviceConfiguration.getDescriptionShort());
            statement.setString(++i, serviceConfiguration.getDescriptionLong());

            statement.setString(++i, serviceConfiguration.getAddress());
            statement.setString(++i, serviceConfiguration.getCity());
            statement.setObject(++i, serviceConfiguration.getPincode());
            statement.setString(++i, serviceConfiguration.getLandmark());
            statement.setString(++i, serviceConfiguration.getState());
            statement.setString(++i, serviceConfiguration.getCountry());

            statement.setString(++i, serviceConfiguration.getISOCountryCode());
            statement.setString(++i, serviceConfiguration.getISOLanguageCode());
            statement.setString(++i, serviceConfiguration.getISOCurrencyCode());

            statement.setObject(++i, serviceConfiguration.getServiceType());

            statement.setObject(++i, serviceConfiguration.getLatCenter());
            statement.setObject(++i, serviceConfiguration.getLonCenter());

            statement.setObject(++i, serviceConfiguration.getServiceRange());

            statement.setObject(++i, serviceConfiguration.getOfficial());
            statement.setObject(++i, serviceConfiguration.getVerified());
            statement.setString(++i, serviceConfiguration.getServiceURL());

            statement.setObject(++i, serviceConfiguration.getCreated());
            statement.setObject(++i, serviceConfiguration.getUpdated());

            rowIdOfInsertedRow = statement.executeUpdate();
            ResultSet rs = statement.getGeneratedKeys();

            if(rs.next())
            {
                rowIdOfInsertedRow = rs.getInt(1);
            }

            System.out.println("Key autogenerated ServiceConfiguration : " + rowIdOfInsertedRow);


        } catch (SQLException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        finally
        {

            try {

                if(statement!=null)
                {statement.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            try {

                if(connection!=null)
                {connection.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }


        return rowIdOfInsertedRow;
    }





    public int updateServiceConfig(ServiceConfiguration serviceConfiguration)
    {


        String updateStatement = "UPDATE " + ServiceConfiguration.TABLE_NAME
                + " SET "

                + ServiceConfiguration.LOGO_IMAGE_PATH + "= ?,"
                + ServiceConfiguration.BACKDROP_IMAGE_PATH + "= ?,"

                + ServiceConfiguration.SERVICE_NAME + "= ?,"
                + ServiceConfiguration.HELPLINE_NUMBER + "= ?,"

                + ServiceConfiguration.DESCRIPTION_SHORT + "=?,"
                + ServiceConfiguration.DESCRIPTION_LONG + "=?,"

                + ServiceConfiguration.ADDRESS + "=?,"
                + ServiceConfiguration.CITY + "=?,"
                + ServiceConfiguration.PINCODE + "=?,"
                + ServiceConfiguration.LANDMARK + "=?,"
                + ServiceConfiguration.STATE + "=?,"
                + ServiceConfiguration.COUNTRY + "=?,"

                + ServiceConfiguration.ISO_COUNTRY_CODE + "=?,"
                + ServiceConfiguration.ISO_LANGUAGE_CODE + "=?,"
                + ServiceConfiguration.ISO_CURRENCY_CODE + "=?,"

                + ServiceConfiguration.SERVICE_TYPE + "=?,"

                + ServiceConfiguration.LAT_CENTER + "=?,"
                + ServiceConfiguration.LON_CENTER + "=?,"

                + ServiceConfiguration.SERVICE_RANGE + "=?,"

//                + ServiceConfiguration.IS_OFFICIAL_SERVICE_PROVIDER + "=?,"
//                + ServiceConfiguration.IS_VERIFIED + "=?,"
//                + ServiceConfiguration.SERVICE_URL + "=?,"

                + ServiceConfiguration.CREATED + "=?,"
                + ServiceConfiguration.UPDATED + "=?"

                + " WHERE " + ServiceConfiguration.SERVICE_URL + " = ?";



        Connection connection = null;
        PreparedStatement statement = null;
        int updatedRows = -1;

        try {

            connection = dataSource.getConnection();
            statement = connection.prepareStatement(updateStatement);


            int i = 0;
            statement.setString(++i, serviceConfiguration.getLogoImagePath());
            statement.setString(++i, serviceConfiguration.getBackdropImagePath());
            statement.setString(++i, serviceConfiguration.getServiceName());
            statement.setString(++i, serviceConfiguration.getHelplineNumber());

            statement.setString(++i, serviceConfiguration.getDescriptionShort());
            statement.setString(++i, serviceConfiguration.getDescriptionLong());

            statement.setString(++i, serviceConfiguration.getAddress());
            statement.setString(++i, serviceConfiguration.getCity());
            statement.setObject(++i, serviceConfiguration.getPincode());
            statement.setString(++i, serviceConfiguration.getLandmark());
            statement.setString(++i, serviceConfiguration.getState());
            statement.setString(++i, serviceConfiguration.getCountry());

            statement.setString(++i, serviceConfiguration.getISOCountryCode());
            statement.setString(++i, serviceConfiguration.getISOLanguageCode());
            statement.setString(++i, serviceConfiguration.getISOCurrencyCode());

            statement.setObject(++i, serviceConfiguration.getServiceType());

            statement.setObject(++i, serviceConfiguration.getLatCenter());
            statement.setObject(++i, serviceConfiguration.getLonCenter());

            statement.setObject(++i, serviceConfiguration.getServiceRange());

//            statement.setObject(++i,serviceConfiguration.getOfficial());
//            statement.setObject(++i,serviceConfiguration.getVerified());

            statement.setObject(++i, serviceConfiguration.getCreated());
            statement.setObject(++i, serviceConfiguration.getUpdated());
            statement.setString(++i, serviceConfiguration.getServiceURL());

            updatedRows = statement.executeUpdate();


            System.out.println("Total rows updated: " + updatedRows);

            //conn.close();

        } catch (SQLException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        finally

        {

            try {

                if(statement!=null)
                {statement.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            try {

                if(connection!=null)
                {connection.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }

        return updatedRows;
    }






    public int updateServiceConfigByStaff(ServiceConfiguration serviceConfiguration)
    {


        String updateStatement =
                        " UPDATE " + ServiceConfiguration.TABLE_NAME +
                        " SET " + ServiceConfiguration.IS_OFFICIAL_SERVICE_PROVIDER + "=?,"
                                + ServiceConfiguration.IS_VERIFIED + "=?"
                        + " WHERE " + ServiceConfiguration.SERVICE_URL + " = ?";


        Connection connection = null;
        PreparedStatement statement = null;
        int updatedRows = -1;

        try {

            connection = dataSource.getConnection();
            statement = connection.prepareStatement(updateStatement);


            int i = 0;
            statement.setObject(++i, serviceConfiguration.getOfficial());
            statement.setObject(++i, serviceConfiguration.getVerified());
            statement.setObject(++i, serviceConfiguration.getServiceURL());
            updatedRows = statement.executeUpdate();


            System.out.println("Total rows updated: " + updatedRows);

            //conn.close();

        } catch (SQLException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        finally

        {

            try {

                if(statement!=null)
                {statement.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            try {

                if(connection!=null)
                {connection.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }

        return updatedRows;

    }




    public int deleteServiceConfig(int serviceConfigurationID)
    {

        String deleteStatement = "DELETE FROM " + ServiceConfiguration.TABLE_NAME
                + " WHERE " + ServiceConfiguration.SERVICE_CONFIGURATION_ID + "= ?";


        Connection connection= null;
        PreparedStatement statement = null;
        int rowCountDeleted = 0;
        try {

            connection = dataSource.getConnection();
            statement = connection.prepareStatement(deleteStatement);
            statement.setObject(1,serviceConfigurationID);


            rowCountDeleted = statement.executeUpdate();
            System.out.println(" Deleted Count: " + rowCountDeleted);

            connection.close();

        } catch (SQLException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

        finally

        {

            try {

                if(statement!=null)
                {statement.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            try {

                if(connection!=null)
                {connection.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }


        return rowCountDeleted;
    }



    public ServiceConfigEndpoint getServices(
            Double latCenter, Double lonCenter,
            String serviceURL, String searchString,
            Boolean isOfficial, Boolean isVerified,
            Integer serviceType,
            boolean filterByVisibility,
            String sortBy,
            Integer limit, Integer offset
    )
    {

        String query = "";
        String queryJoin = "";

        // flag for tracking whether to put "AND" or "WHERE"
        boolean isFirst = true;


        String queryNormal = "SELECT "
                + "6371 * acos( cos( radians("
                + latCenter + ")) * cos( radians( " + ServiceConfiguration.LAT_CENTER + ") ) * cos(radians( " + ServiceConfiguration.LON_CENTER + " ) - radians("
                + lonCenter + "))" + " + sin( radians(" + latCenter + ")) * sin(radians( " + ServiceConfiguration.LAT_CENTER + " ))) as distance" + ","

                + "count(*) over() AS full_count " + ","

                + ServiceConfiguration.SERVICE_CONFIGURATION_ID + ","
                + ServiceConfiguration.LOGO_IMAGE_PATH + ","
                + ServiceConfiguration.BACKDROP_IMAGE_PATH + ","

                + ServiceConfiguration.SERVICE_NAME + ","
                + ServiceConfiguration.HELPLINE_NUMBER + ","

                + ServiceConfiguration.DESCRIPTION_SHORT + ","
                + ServiceConfiguration.DESCRIPTION_LONG + ","

                + ServiceConfiguration.ADDRESS + ","
                + ServiceConfiguration.CITY + ","
                + ServiceConfiguration.PINCODE + ","
                + ServiceConfiguration.LANDMARK + ","
                + ServiceConfiguration.STATE + ","
                + ServiceConfiguration.COUNTRY + ","

                + ServiceConfiguration.ISO_COUNTRY_CODE + ","
                + ServiceConfiguration.ISO_LANGUAGE_CODE + ","
                + ServiceConfiguration.ISO_CURRENCY_CODE + ","

                + ServiceConfiguration.SERVICE_TYPE + ","

                + ServiceConfiguration.LAT_CENTER + ","
                + ServiceConfiguration.LON_CENTER + ","

                + ServiceConfiguration.SERVICE_RANGE + ","

//                + ServiceConfiguration.IS_OFFICIAL_SERVICE_PROVIDER + ","
//                + ServiceConfiguration.IS_VERIFIED + ","
                + ServiceConfiguration.SERVICE_URL + ","

                + ServiceConfiguration.CREATED + ","
                + ServiceConfiguration.UPDATED + ""

                + " FROM " + ServiceConfiguration.TABLE_NAME;



        // Visibility Filter : Apply
        if(filterByVisibility && latCenter != null && lonCenter != null)
        {

            String queryPartlatLonCenter = "";

            queryNormal = queryNormal + " WHERE ";

            // reset the flag
            isFirst = false;

            queryPartlatLonCenter = queryPartlatLonCenter
                    + "6371 * acos( cos( radians("
                    + latCenter + ")) * cos( radians( " + ServiceConfiguration.LAT_CENTER + ") ) * cos(radians( " + ServiceConfiguration.LON_CENTER + " ) - radians("
                    + lonCenter + "))" + " + sin( radians(" + latCenter + ")) * sin(radians( " + ServiceConfiguration.LAT_CENTER + " ))) <= " + ServiceConfiguration.SERVICE_RANGE;

            queryNormal = queryNormal + queryPartlatLonCenter;

        }



//        // Proximity Filter
//        if(proximity != null)
//        {
//            // proximity > 0 && (deliveryRangeMax==0 || (deliveryRangeMax > 0 && proximity <= deliveryRangeMax))
//
//            String queryPartProximity = "";
////			String queryPartProximityTwo = "";
//
//
//            // filter using Haversine formula using SQL math functions
//            queryPartProximity = queryPartProximity
//                    + " (6371.01 * acos(cos( radians(" + latCenter + ")) * cos( radians(" + ServiceConfiguration.LAT_CENTER + " )) * cos(radians( "
//                    + ServiceConfiguration.LON_CENTER + ") - radians(" + lonCenter + "))" + " + sin( radians(" + latCenter + ")) * sin(radians("
//                    + ServiceConfiguration.LAT_CENTER + ")))) <= " + proximity ;
//
//
//            if(isFirst)
//            {
//                queryNormal = queryNormal + " WHERE " + queryPartProximity;
//
//                // reset the flag
//                isFirst = false;
//
//            }else
//            {
//                queryNormal = queryNormal + " AND " + queryPartProximity;
//            }
//
//        }


        if(isOfficial!=null)
        {
            String queryPartOfficial = "";

            queryPartOfficial = queryPartOfficial + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.IS_OFFICIAL_SERVICE_PROVIDER + " = " + isOfficial;

            if(isFirst)
            {
                queryNormal = queryNormal + " WHERE " + queryPartOfficial;

                // reset the flag
                isFirst = false;

            }else
            {
                queryNormal = queryNormal + " AND " + queryPartOfficial;
            }
        }



        if(isVerified!=null)
        {
            String queryPartVerified = "";

            queryPartVerified = queryPartVerified + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.IS_VERIFIED + " = " + isVerified;

            if(isFirst)
            {
                queryNormal = queryNormal + " WHERE " + queryPartVerified;

                // reset the flag
                isFirst = false;

            }else
            {
                queryNormal = queryNormal + " AND " + queryPartVerified;
            }
        }



        if(serviceType!=null)
        {
            String queryPartServiceType = "";

            queryPartServiceType = queryPartServiceType + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.SERVICE_TYPE + " = " + serviceType;

            if(isFirst)
            {
                queryNormal = queryNormal + " WHERE " + queryPartServiceType;

                // reset the flag
                isFirst = false;

            }else
            {
                queryNormal = queryNormal + " AND " + queryPartServiceType;
            }
        }



        if(searchString !=null)
        {
            String queryPartSearch = "(" + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.SERVICE_NAME +" ilike '%" + searchString + "%'"
                    + " or " + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.ADDRESS + " ilike '%" + searchString + "%'"
                    + " or " + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.CITY + " ilike '%" + searchString + "%' )";



            if(isFirst)
            {
//				queryJoin = queryJoin + " WHERE " + queryPartSearch;

                queryNormal = queryNormal + " WHERE " + queryPartSearch;

                isFirst = false;
            }
            else
            {
                queryNormal = queryNormal + " AND " + queryPartSearch;
            }
        }




        if(serviceURL !=null)
        {
            String serviceURLquery = "(" + ServiceConfiguration.TABLE_NAME + "." + ServiceConfiguration.SERVICE_URL + " = " + serviceURL + " )";


            if(isFirst)
            {
                queryNormal = queryNormal + " WHERE " + serviceURLquery;

                isFirst = false;
            }
            else
            {
                queryNormal = queryNormal + " AND " + serviceURLquery;
            }
        }



//
//        String queryGroupBy = "";
//
//        queryGroupBy = queryGroupBy + " group by "
//                + Shop.TABLE_NAME + "." + Shop.SHOP_ID ;
//

//        queryNormal = queryNormal + queryGroupBy;




        // Applying Filters



        if(sortBy!=null)
        {
            if(!sortBy.equals(""))
            {
                String queryPartSortBy = " ORDER BY " + sortBy;

                queryNormal = queryNormal + queryPartSortBy;
            }
        }



        if(limit !=null)
        {

            String queryPartLimitOffset = "";

            if(offset!=null)
            {
                queryPartLimitOffset = " LIMIT " + limit + " " + " OFFSET " + offset;

            }else
            {
                queryPartLimitOffset = " LIMIT " + limit + " " + " OFFSET " + 0;
            }


            queryNormal = queryNormal + queryPartLimitOffset;
        }



        query = queryNormal;





        ServiceConfigEndpoint endPoint = new ServiceConfigEndpoint();
        endPoint.setItemCount(0);

        ArrayList<ServiceConfiguration> shopList = new ArrayList<>();


        Connection connection = null;
        Statement statement = null;
        ResultSet rs = null;

//        System.out.println("Query\n" + query);


        try {

            connection = dataSource.getConnection();
            statement = connection.createStatement();

            rs = statement.executeQuery(query);

            while(rs.next())
            {

                ServiceConfiguration sc = new ServiceConfiguration();

                sc.setRt_distance(rs.getDouble("distance"));

                sc.setServiceID(rs.getInt(ServiceConfiguration.SERVICE_CONFIGURATION_ID));
                sc.setLogoImagePath(rs.getString(ServiceConfiguration.LOGO_IMAGE_PATH));
                sc.setBackdropImagePath(rs.getString(ServiceConfiguration.BACKDROP_IMAGE_PATH));
                sc.setServiceName(rs.getString(ServiceConfiguration.SERVICE_NAME));
                sc.setHelplineNumber(rs.getString(ServiceConfiguration.HELPLINE_NUMBER));

                sc.setDescriptionShort(rs.getString(ServiceConfiguration.DESCRIPTION_SHORT));
                sc.setDescriptionLong(rs.getString(ServiceConfiguration.DESCRIPTION_LONG));

                sc.setAddress(rs.getString(ServiceConfiguration.ADDRESS));
                sc.setCity(rs.getString(ServiceConfiguration.CITY));
                sc.setPincode(rs.getLong(ServiceConfiguration.PINCODE));
                sc.setLandmark(rs.getString(ServiceConfiguration.LANDMARK));
                sc.setState(rs.getString(ServiceConfiguration.STATE));
                sc.setCountry(rs.getString(ServiceConfiguration.COUNTRY));

                sc.setISOCountryCode(rs.getString(ServiceConfiguration.ISO_COUNTRY_CODE));
                sc.setISOLanguageCode(rs.getString(ServiceConfiguration.ISO_LANGUAGE_CODE));
                sc.setISOCurrencyCode(rs.getString(ServiceConfiguration.ISO_CURRENCY_CODE));

                sc.setServiceType(rs.getInt(ServiceConfiguration.SERVICE_TYPE));

                sc.setLatCenter(rs.getDouble(ServiceConfiguration.LAT_CENTER));
                sc.setLonCenter(rs.getDouble(ServiceConfiguration.LON_CENTER));

                sc.setServiceRange(rs.getInt(ServiceConfiguration.SERVICE_RANGE));

//                sc.setOfficial(rs.getBoolean(ServiceConfiguration.IS_OFFICIAL_SERVICE_PROVIDER));
//                sc.setVerified(rs.getBoolean(ServiceConfiguration.IS_VERIFIED));
                sc.setServiceURL(rs.getString(ServiceConfiguration.SERVICE_URL));

                sc.setCreated(rs.getTimestamp(ServiceConfiguration.CREATED));
                sc.setUpdated(rs.getTimestamp(ServiceConfiguration.UPDATED));

                endPoint.setItemCount(rs.getInt("full_count"));
                shopList.add(sc);
            }

            System.out.println("Total queried " + shopList.size());


            endPoint.setResults(shopList);


        } catch (SQLException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }


        finally

        {

            try {
                if(rs!=null)
                {rs.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            try {

                if(statement!=null)
                {statement.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            try {

                if(connection!=null)
                {connection.close();}
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }

        return endPoint;
    }

}
